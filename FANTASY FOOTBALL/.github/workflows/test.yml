name: Neuron Test Suite

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:  # Allow manual triggers

jobs:
  # Quick tests that don't require API keys
  unit-tests:
    runs-on: ubuntu-latest
    name: Unit Tests
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests websockets pytest pytest-asyncio
          
      - name: Run ESPN Integration Tests
        run: python tests/realtime/test_espn_integration.py
        
      - name: Run Event Classification Tests
        run: python tests/realtime/test_espn_integration.py


  # Integration tests that require API access
  integration-tests:
    runs-on: ubuntu-latest
    name: Integration Tests
    if: github.event_name == 'workflow_dispatch'  # Only on manual trigger
    
    env:
      MODAL_TOKEN_ID: ${{ secrets.MODAL_TOKEN_ID }}
      MODAL_TOKEN_SECRET: ${{ secrets.MODAL_TOKEN_SECRET }}
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests websockets pytest pytest-asyncio
          
      - name: Run Backend Tests
        run: python tests/automated_backend_tests.py
        continue-on-error: true
        
      - name: Run Quality Tests
        run: python tests/quality/test_content_quality.py
        continue-on-error: true
        
      - name: Run Audio Output Tests
        run: python tests/output/test_audio_output.py
        continue-on-error: true


  # P0 Critical Timing Tests (manual only - costs money)
  timing-tests:
    runs-on: ubuntu-latest
    name: P0 Timing Tests
    if: github.event_name == 'workflow_dispatch'
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests websockets pytest pytest-asyncio
          
      - name: Run P0 Pipeline Timing Tests
        run: python tests/e2e/test_full_pipeline_timing.py
